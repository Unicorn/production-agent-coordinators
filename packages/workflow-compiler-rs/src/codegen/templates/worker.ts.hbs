/**
 * Generated Temporal Worker
 *
 * @generated by workflow-compiler v{{version}}
 * @date {{generated_at}}
 * @workflow {{workflow_name}}
 */

import { Worker, NativeConnection } from '@temporalio/worker';
import { createActivities } from './activities';

/**
 * Worker configuration
 */
interface WorkerConfig {
  taskQueue: string;
  temporalAddress?: string;
  namespace?: string;
}

/**
 * Get worker configuration from environment
 */
function getConfig(): WorkerConfig {
  return {
    taskQueue: process.env.TEMPORAL_TASK_QUEUE ?? '{{workflow_name}}-task-queue',
    temporalAddress: process.env.TEMPORAL_ADDRESS ?? 'localhost:7233',
    namespace: process.env.TEMPORAL_NAMESPACE ?? 'default',
  };
}

/**
 * Create and start the Temporal worker
 */
async function run(): Promise<void> {
  const config = getConfig();

  console.log('Starting worker with config:', config);

  // Create connection to Temporal server
  const connection = await NativeConnection.connect({
    address: config.temporalAddress,
  });

  try {
    // Create worker
    const worker = await Worker.create({
      connection,
      namespace: config.namespace,
      taskQueue: config.taskQueue,
      workflowsPath: require.resolve('./workflow'),
      activities: createActivities(),
    });

    console.log(`Worker connected to ${config.temporalAddress}`);
    console.log(`Listening on task queue: ${config.taskQueue}`);

    // Start the worker
    await worker.run();
  } finally {
    await connection.close();
  }
}

// Run the worker
run().catch((error) => {
  console.error('Worker failed to start:', error);
  process.exit(1);
});
