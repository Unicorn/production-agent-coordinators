# Test Setup and Verification Guide

## Prerequisites Checklist

Before running integration tests, verify:

### 1. Temporal Server Status

```bash
# Check if Temporal is running
docker ps | grep temporal

# Expected output:
# - temporal container (temporalio/auto-setup:1.23) - Running
# - temporal-ui container (temporalio/ui) - Running

# If not running, start Temporal:
cd /path/to/project
docker-compose -f docker/temporal/docker-compose.temporal.yml up -d

# Wait for Temporal to be ready (30-60 seconds)
timeout 60 bash -c 'until curl -f http://localhost:7233/health 2>/dev/null; do echo "Waiting for Temporal..."; sleep 2; done'
```

### 2. Verify Temporal Connectivity

```bash
# Test Temporal connection
curl http://localhost:7233/health

# Expected: Should return without error

# Test Temporal UI
curl http://localhost:8080

# Expected: HTML response from Temporal UI
```

### 3. Environment Variables

```bash
# Check required environment variables
echo $TEMPORAL_ADDRESS
echo $TEMPORAL_NAMESPACE

# If not set, export them:
export TEMPORAL_ADDRESS=localhost:7233
export TEMPORAL_NAMESPACE=default
```

### 4. Node.js Dependencies

```bash
# From workflow-builder directory
cd packages/workflow-builder

# Install dependencies
npm install

# Verify TypeScript compilation works
npm run typecheck
```

## Running the Tests

### Quick Start

```bash
# 1. Start Temporal (if not running)
docker-compose -f ../../docker/temporal/docker-compose.temporal.yml up -d

# 2. Wait for Temporal to be ready
sleep 30

# 3. Run integration tests
npm test tests/integration/compiler-execution
```

### Individual Test Suites

```bash
# End-to-end tests (basic functionality)
npm test tests/integration/compiler-execution/end-to-end.test.ts

# Retry handling tests
npm test tests/integration/compiler-execution/retry-handling.test.ts

# Timeout handling tests
npm test tests/integration/compiler-execution/timeout-handling.test.ts
```

### With Verbose Output

```bash
# Enable debug logging
DEBUG=temporal* npm test tests/integration/compiler-execution

# Or with Vitest UI
npm test -- --ui tests/integration/compiler-execution
```

## Troubleshooting

### Issue: Temporal Connection Refused

**Symptoms:**
- Tests fail with "Connection refused"
- Error: "ECONNREFUSED localhost:7233"

**Solution:**
```bash
# 1. Check if Temporal is running
docker ps | grep temporal

# 2. Check Temporal logs
docker logs workflow-builder-temporal

# 3. Restart Temporal if needed
docker-compose -f docker/temporal/docker-compose.temporal.yml down
docker-compose -f docker/temporal/docker-compose.temporal.yml up -d

# 4. Wait for startup
sleep 30
```

### Issue: Worker Registration Fails

**Symptoms:**
- Error: "Failed to register workflow"
- TypeScript compilation errors in test output

**Solution:**
```bash
# 1. Check generated code is valid
# Run single test with verbose output
npm test -- --reporter=verbose tests/integration/compiler-execution/end-to-end.test.ts

# 2. Verify compiler types
npm run typecheck

# 3. Check activity exports
# Ensure test activities are properly defined in test-helpers.ts
```

### Issue: Tests Timeout

**Symptoms:**
- Tests hang and eventually timeout
- No error messages, just timeout

**Solution:**
```bash
# 1. Increase test timeout in individual tests
# Edit test file, increase timeout value:
# it('test name', async () => { ... }, 120000); // 120 seconds

# 2. Check worker logs
# Look for worker errors in test output

# 3. Verify Temporal is healthy
curl http://localhost:7233/health
```

### Issue: Flaky Tests

**Symptoms:**
- Tests pass sometimes, fail other times
- Inconsistent results

**Solution:**
This indicates a real issue that needs investigation:

1. Check for race conditions in test setup
2. Verify worker readiness before execution
3. Ensure proper cleanup between tests
4. Check Temporal resource limits

**Do not just increase timeouts** - find root cause.

## Expected Test Results

### Success Criteria

All tests should pass with output similar to:

```
✓ tests/integration/compiler-execution/end-to-end.test.ts (12 tests)
  ✓ Basic Workflow Compilation and Execution
    ✓ should compile simple workflow and execute in Temporal (5.2s)
    ✓ should compile workflow with 5 activities and execute successfully (8.1s)
    ✓ should execute workflow immediately after registration (4.3s)
  ✓ Concurrent Workflow Execution
    ✓ should execute 5 different workflows simultaneously (15.4s)
  ✓ Workflow History and Monitoring
    ✓ should be able to query workflow execution history (6.7s)
  ... (more tests)

✓ tests/integration/compiler-execution/retry-handling.test.ts (8 tests)
  ✓ Activity Retry with Exponential Backoff
    ✓ should retry failed activity with exponential backoff (12.5s)
    ✓ should respect maxAttempts in retry policy (8.2s)
  ... (more tests)

✓ tests/integration/compiler-execution/timeout-handling.test.ts (10 tests)
  ✓ Activity Timeout
    ✓ should timeout slow activity when timeout is exceeded (4.1s)
    ✓ should complete activity that finishes before timeout (2.3s)
  ... (more tests)

Test Files  3 passed (3)
     Tests  30 passed (30)
  Start at  16:30:45
  Duration  3.5m (tests run in 180.2s)
```

### Performance Benchmarks

Expected execution times:

| Test Suite | Expected Duration | Max Duration |
|------------|------------------|--------------|
| end-to-end.test.ts | 60-90s | 120s |
| retry-handling.test.ts | 90-120s | 180s |
| timeout-handling.test.ts | 60-90s | 120s |
| **Total** | **3-5 minutes** | **7 minutes** |

If tests take significantly longer, investigate performance issues.

## Continuous Integration

### GitHub Actions Setup

```yaml
name: Integration Tests

on: [push, pull_request]

jobs:
  integration-tests:
    runs-on: ubuntu-latest

    services:
      temporal:
        image: temporalio/auto-setup:1.23
        ports:
          - 7233:7233
        env:
          DB: sqlite
          DEFAULT_NAMESPACE: default

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Wait for Temporal
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:7233/health; do sleep 2; done'

      - name: Run integration tests
        env:
          TEMPORAL_ADDRESS: localhost:7233
          TEMPORAL_NAMESPACE: default
        run: npm test tests/integration/compiler-execution

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: test-results/
```

## Test Maintenance

### Adding New Tests

1. Create workflow fixture in `fixtures/` if needed
2. Add test case to appropriate test file
3. Use `IntegrationTestContext` for setup/cleanup
4. Set realistic timeout (tests usually 10-60s)
5. Run locally to verify
6. Update this documentation if new prerequisites added

### Updating Fixtures

When workflow schema changes:
1. Update fixture definitions
2. Update tests that use those fixtures
3. Run full test suite to verify
4. Update README if behavior changes

### Debugging Failed Tests

1. Run single test in isolation:
   ```bash
   npm test -- --reporter=verbose tests/integration/compiler-execution/end-to-end.test.ts -t "should compile simple workflow"
   ```

2. Check Temporal UI for execution history:
   - Open http://localhost:8080
   - Find workflow by ID (from test output)
   - Review event history

3. Enable debug logging:
   ```bash
   DEBUG=temporal* npm test
   ```

4. Check worker output in test logs

## Success Criteria (M1-T081)

All acceptance criteria must pass:

- ✅ Test: Compile workflow, execute in Temporal, verify completion
- ✅ Test: Compile workflow with retry, force failure, verify retry occurs
- ✅ Test: Compile workflow with timeout, force slow activity, verify timeout
- ✅ Test: Compile 5 different workflows, execute all simultaneously
- ✅ Test: Compile workflow, register with worker, execute immediately
- ✅ Test: Compile invalid workflow, verify compiler error

All testing requirements must be met:

- ✅ Tests use real Temporal instance (not mocked)
- ✅ Tests have proper cleanup (workers shutdown, temp files removed)
- ✅ Tests verify actual Temporal execution (check workflow history)

## Next Steps

After all tests pass:

1. Review test coverage report
2. Document any known limitations
3. Update CI/CD pipeline configuration
4. Mark M1-T081 as complete
5. Proceed to next milestone task
