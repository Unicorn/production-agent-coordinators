# AGENTINFO.md: Agent Orchestration and Development Guidelines

This document outlines the conventions, architectural patterns, and best practices for developing and integrating AI agents, particularly those leveraging the Gemini CLI, within our Temporal-based systems. Its purpose is to standardize agent interactions, ensure durability, optimize token usage, and facilitate continuous improvement.

## 1. Core Architectural Principle: Headless CLI Orchestration

Our primary method for interacting with AI agents is through orchestrating the Gemini CLI in a headless, non-interactive mode. This leverages the CLI's robust capabilities for tool execution, file system access, and context management, while offloading durability, retry logic, and complex sequencing to Temporal Workflows.

### 1.1 Key CLI Flags for Agent Mode

*   `--prompt "<instruction>"`: Provides the specific task or instruction for the agent.
*   `--context <file_path>`: Specifies a file (typically `GEMINI.md`) containing detailed context for the agent's current task.
*   `--output-format json`: Ensures the CLI returns structured JSON output, which is crucial for programmatic parsing within Temporal Activities.
*   `--yolo`: (Use with extreme caution and in controlled environments) Auto-approves tool execution (e.g., file writes, shell commands), turning the CLI into an autonomous agent controlled by the workflow. This is fundamental for hands-off execution within Temporal.

### 1.2 `GEMINI.md`: The Agent's Dynamic Brain

`GEMINI.md` serves as the primary mechanism for injecting context into the agent's current operational state. It is dynamically generated and updated by Temporal Activities for each specific step of a workflow.

**Structure for `GEMINI.md`:**

To achieve "First-Pass Quality" and minimize rework, `GEMINI.md` should always be structured to provide a clear directive, strict constraints, and relevant input specifications.

```markdown
# AGENT DIRECTIVE: <Specific Task Title>

> **ROLE**: <Persona/Role for the Agent, e.g., Senior TypeScript Engineer & QA Specialist.>
> **OBJECTIVE**: <Clear, concise objective for the current step.>

## üõë STRICT CONSTRAINTS (CRITICAL)
<List of non-negotiable rules, e.g., type safety, no 'any', dependency rules, style guides.>
<These constraints should directly address common LLM hallucinations and project-specific quality gates.>

## üìù INPUT SPECIFICATION
<Specific inputs for the current task, e.g., package specification, API definitions, user requirements.>

## üõ°Ô∏è VERIFICATION PROTOCOL
<Commands or criteria the agent's output will be immediately tested against, e.g., `tsc --noEmit`, `npm test`.>
<Emphasize that failure here means job failure for the agent.>
```

## 2. Temporal Integration for Agent Orchestration

Temporal Workflows are used to orchestrate the lifecycle of agent interactions, providing durability, observability, and retry mechanisms.

### 2.1 Activities

*   **`executeGeminiAgent`**: (New Activity) A generic activity wrapping the Gemini CLI execution. It handles context injection via `GEMINI.md`, command execution with `--yolo` and `--output-format json`, and parses the structured output. This will likely abstract the core LLM interaction from `executeAgentTask` to allow for different LLM providers (e.g., Anthropic, Gemini CLI).
*   **`runComplianceChecks`**: (New Activity) An activity responsible for executing project-specific validation commands (e.g., `npm install`, `npm run build`, `npm run lint`, `npm test`) and reporting their success or failure with detailed output. This activity will leverage existing build, test, and quality check activities (`runBuild`, `runTests`, `runQualityChecks`).
*   **`setupWorkspace`**: (New Activity) Creates an isolated, temporary working directory for each agent session.
*   **`logAuditEntry`**: (New Activity) Records detailed metrics and events for each agent interaction for audit and optimization purposes.
*   **Existing Agent-related Activities**:
    *   `initializeWorkflow`, `executeSpecDecision`, `executeAgentStep`, `processAgentResponse`, `storeArtifact`: These form the foundation of our existing agent interaction loop.
    *   `executeAgentTask`: This activity currently implements an iterative agent interaction with tool use (via Anthropic API), validation, and change summarization. This activity provides a strong pattern for implementing the `executeGeminiAgent` logic, specifically its tool integration and iterative execution. Future refactoring might involve abstracting the LLM provider within `executeAgentTask` or creating a dedicated `executeGeminiAgent` that follows a similar structure.

### 2.2 Workflows

*   **`AuditedBuildWorkflow`**: (New Workflow) A primary example of an agent orchestration workflow for package building. It manages the entire process of scaffolding, implementing, and iteratively correcting code generated by the agent, based on predefined specifications and compliance checks.
*   **`helloWorkflow`**: An existing example workflow demonstrating a basic agent interaction loop.
*   **External Workflow Re-exports**: Existing workflows re-export from `@coordinator/agent-package-builder-production/dist/workflows/`. This indicates a pattern of defining domain-specific workflows in separate packages and integrating them into the `temporal-coordinator`. New agent workflows should consider this modularity.

### 2.3 Determinism in Temporal Workflows and Activities

**CRITICAL CONSIDERATION**: Temporal Workflows *must* be deterministic. This means that given the same inputs, a workflow must always produce the same sequence of commands to activities, the same child workflows, and the same timers, regardless of when or where it is executed. Activities, on the other hand, can be non-deterministic.

**Current Issues Observed:**

*   **`workflows.ts`**: The `helloWorkflow` currently uses `Date.now()` (e.g., for `step.updatedAt`). This is a direct violation of Temporal's determinism rules for workflows.
    *   **Resolution**: Replace `Date.now()` with `workflow.now()` or derive time deterministically within the workflow context.
*   **`activities.ts`**: Activities like `initializeWorkflow`, `executeSpecDecision`, and `processAgentResponse` use `Date.now()` and `Math.random()` within `SpecExecutionContext`. While activities can be non-deterministic, if these values influence the `EngineState` that the workflow relies on for deterministic decisions (e.g., branching logic, command sequencing), they must be derived deterministically by the workflow and passed into the activity.
    *   **Resolution**: Where `Date.now()` and `Math.random()` are used to influence the workflow's logical path or state transitions in a way that is visible to the workflow, they should be replaced by values obtained deterministically from the workflow (e.g., `workflow.now()`, `workflow.random()`, or a seeded random function provided by the workflow). If these are purely for activity-internal logging or non-critical metadata, their usage within an activity is acceptable, but review is needed to ensure they don't inadvertently break workflow determinism.

## 3. Optimization and Auditing

Every agent interaction within a workflow is auditable to enable continuous optimization of prompt engineering, constraint definition, and token usage.

### 3.1 `audit_trace.jsonl`: The Optimization Dataset

A JSONL (JSON Lines) file named `audit_trace.jsonl` is generated in each workspace to log detailed `OptimizationLogEntry` records. This data is critical for understanding agent performance, identifying bottlenecks, and informing future improvements.

**Key Metrics Captured:**

*   `step_name`: Identifies the workflow step (e.g., `scaffold`, `implement_v1`, `fix_attempt_1`).
*   `timestamp`: When the step occurred.
*   `prompt_token_count`: Estimated input tokens for the agent.
*   `completion_token_count`: Estimated output tokens from the agent.
*   `total_token_cost`: Sum of prompt and completion tokens.
*   `context_file_hash`: SHA-256 of `GEMINI.md` to track context evolution.
*   `validation_status`: `pass`, `fail`, or `N/A`.
*   `validation_error_type`: Classification of failure (e.g., `TSC_ERROR`, `ESLINT_ERROR`).
*   `error_log_size_chars`: Size of error log fed back to agent during rework.
*   `rework_cost_factor`: Efficiency metric for rework.

### 3.2 Optimization Workflow Methodology

A separate process or workflow analyzes `audit_trace.jsonl` files to perform:

*   **Token Efficiency Audits**: Identify expensive steps and prompt structures.
*   **Constraint Effectiveness Audits**: Validate the impact of `GEMINI.md` constraints on error rates.
*   **Prompt Refinement Audits**: Analyze the effectiveness of specific prompt phrasing.

This iterative process ensures that our agent-driven development continually improves in efficiency, quality, and cost-effectiveness.

---
**Revision History:**

*   **2025-11-29 (Initial Draft)**: Established headless CLI orchestration as core principle, defined `GEMINI.md` structure, outlined key Temporal activities/workflow patterns (`AuditedBuildWorkflow`), introduced `audit_trace.jsonl` and the optimization methodology.
*   **2025-11-29 (Updated based on Code Review)**: Incorporated observations from `packages/temporal-coordinator/src/workflows.ts` and `activities.ts`, detailing existing agent activities, external workflow re-export patterns, and highlighted critical determinism violations (e.g., `Date.now()` in workflows and critical activity contexts) with proposed resolutions. Refined `executeGeminiAgent` to integrate with existing `executeAgentTask` patterns.
